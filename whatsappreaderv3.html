<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Chat Reader - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --page-bg: #f0f2f5;
            --container-bg: #ffffff;
            --chat-bg: #e5ddd5;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --bubble-user-bg: #dcf8c6;
            --bubble-other-bg: #ffffff;
            --system-bg: #e1f3fb;
            --system-text: #505d62;
            --header-bg: #005c4b; /* Darker green */
            --header-text: #ffffff;
            --border-color: #e0e0e0;
            --highlight-bg: #fffb00;
            --icon-color: #8696a0;
            --button-bg: #008069; /* WhatsApp Green */
            --button-text: #ffffff;
            --link-color: #007bff;
        }

        .dark-theme {
            --page-bg: #111b21; /* Dark background */
            --container-bg: #202c33; /* Darker container */
            --chat-bg: #0b141a; /* Very dark chat area */
            --text-primary: #e9edef; /* Light text */
            --text-secondary: #8696a0; /* Lighter secondary text */
            --bubble-user-bg: #005c4b; /* Dark Green bubble */
            --bubble-other-bg: #202c33; /* Darker container color for bubbles */
            --system-bg: #182229; /* Dark system messages */
            --system-text: #8696a0;
            --header-bg: #202c33;
            --border-color: #344047;
            --highlight-bg: #facc15; /* Yellow highlight */
            --icon-color: #8696a0;
            --button-bg: #00a884; /* Brighter Green */
            --link-color: #58b4f5; /* Lighter blue */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--page-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background-color: var(--container-bg);
            transition: background-color 0.3s;
        }

        header, .upload-section {
            background-color: var(--header-bg); /* Adjusted upload section bg */
            color: var(--header-text);
            transition: background-color 0.3s;
        }
        .upload-section {
             background-color: var(--container-bg);
             color: var(--text-primary);
        }
        .upload-section label { color: var(--button-bg); }
        .upload-section input { color: var(--text-secondary); }

        #chat-display-area {
            background-color: var(--chat-bg);
            height: 65vh;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }
        #chat-display-area::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }
        .dark-theme #chat-display-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

        .message-wrapper { margin-bottom: 2px; /* Tighter spacing */ }
        .message-bubble {
            padding: 7px 10px;
            border-radius: 7.5px;
            max-width: 70%;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0,0,0,0.08);
            position: relative;
            transition: background-color 0.3s;
        }
        
        /* Message Tails */
        .message-bubble::before {
            content: "";
            position: absolute;
            bottom: 0px;
            width: 12px;
            height: 19px;
            background-repeat: no-repeat;
            background-size: contain;
        }
        .user-message-wrapper .message-bubble::before {
            right: -11px; /* Position right tail */
            background-image: var(--bubble-user-bg) == #dcf8c6 
                ? url("data:image/svg+xml,%3Csvg width='12' height='19' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10.9999 19C10.9999 19 4.65484 19 0.999905 19C0.999905 19 0.999905 19 0.999905 19C4.83296 19 7.64141 17.8095 9.38817 14.8696C10.0526 13.7917 10.5113 12.3846 10.7417 11.1098C11.0319 9.53108 11.0003 7.82863 11.0003 6.0005C11.0003 4.17237 11.0319 2.46992 10.7417 0.891221C10.5113 -0.383564 10.0526 -1.79069 9.38817 -2.86861C7.64141 -5.8085 4.83296 -7 0.999905 -7C0.999905 -7 0.999905 -7 0.999905 -7C4.65484 -7 10.9999 -7 10.9999 -7L10.9999 19Z' fill='%23dcf8c6'/%3E%3C/svg%3E")
                : url("data:image/svg+xml,%3Csvg width='12' height='19' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10.9999 19C10.9999 19 4.65484 19 0.999905 19C0.999905 19 0.999905 19 0.999905 19C4.83296 19 7.64141 17.8095 9.38817 14.8696C10.0526 13.7917 10.5113 12.3846 10.7417 11.1098C11.0319 9.53108 11.0003 7.82863 11.0003 6.0005C11.0003 4.17237 11.0319 2.46992 10.7417 0.891221C10.5113 -0.383564 10.0526 -1.79069 9.38817 -2.86861C7.64141 -5.8085 4.83296 -7 0.999905 -7C0.999905 -7 0.999905 -7 0.999905 -7C4.65484 -7 10.9999 -7 10.9999 -7L10.9999 19Z' fill='%23005c4b'/%3E%3C/svg%3E");
        }
        .other-message-wrapper .message-bubble::before {
            left: -11px; /* Position left tail */
             background-image: var(--bubble-other-bg) == #ffffff
                ? url("data:image/svg+xml,%3Csvg width='12' height='19' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 19C1 19 7.34506 19 11 19C11 19 11 19 11 19C7.16704 19 4.35859 17.8095 2.61183 14.8696C1.94736 13.7917 1.48866 12.3846 1.25833 11.1098C0.968137 9.53108 0.999701 7.82863 0.999701 6.0005C0.999701 4.17237 0.968137 2.46992 1.25833 0.891221C1.48866 -0.383564 1.94736 -1.79069 2.61183 -2.86861C4.35859 -5.8085 7.16704 -7 11 -7C11 -7 11 -7 11 -7C7.34506 -7 1 -7 1 -7L1 19Z' fill='%23ffffff'/%3E%3C/svg%3E")
                : url("data:image/svg+xml,%3Csvg width='12' height='19' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 19C1 19 7.34506 19 11 19C11 19 11 19 11 19C7.16704 19 4.35859 17.8095 2.61183 14.8696C1.94736 13.7917 1.48866 12.3846 1.25833 11.1098C0.968137 9.53108 0.999701 7.82863 0.999701 6.0005C0.999701 4.17237 0.968137 2.46992 1.25833 0.891221C1.48866 -0.383564 1.94736 -1.79069 2.61183 -2.86861C4.35859 -5.8085 7.16704 -7 11 -7C11 -7 11 -7 11 -7C7.34506 -7 1 -7 1 -7L1 19Z' fill='%23202c33'/%3E%3C/svg%3E");
        }
        /* Make tails adjust with theme - this requires JS or more complex CSS */
        .user-message-wrapper .message-bubble { background-color: var(--bubble-user-bg); }
        .other-message-wrapper .message-bubble { background-color: var(--bubble-other-bg); }
        .message-text { color: var(--text-primary); }
        .dark-theme .user-message-wrapper .message-bubble::before { background-image: url("data:image/svg+xml,%3Csvg width='12' height='19' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10.9999 19C10.9999 19 4.65484 19 0.999905 19C0.999905 19 0.999905 19 0.999905 19C4.83296 19 7.64141 17.8095 9.38817 14.8696C10.0526 13.7917 10.5113 12.3846 10.7417 11.1098C11.0319 9.53108 11.0003 7.82863 11.0003 6.0005C11.0003 4.17237 11.0319 2.46992 10.7417 0.891221C10.5113 -0.383564 10.0526 -1.79069 9.38817 -2.86861C7.64141 -5.8085 4.83296 -7 0.999905 -7C0.999905 -7 0.999905 -7 0.999905 -7C4.65484 -7 10.9999 -7 10.9999 -7L10.9999 19Z' fill='%23005c4b'/%3E%3C/svg%3E"); }
        .dark-theme .other-message-wrapper .message-bubble::before { background-image: url("data:image/svg+xml,%3Csvg width='12' height='19' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 19C1 19 7.34506 19 11 19C11 19 11 19 11 19C7.16704 19 4.35859 17.8095 2.61183 14.8696C1.94736 13.7917 1.48866 12.3846 1.25833 11.1098C0.968137 9.53108 0.999701 7.82863 0.999701 6.0005C0.999701 4.17237 0.968137 2.46992 1.25833 0.891221C1.48866 -0.383564 1.94736 -1.79069 2.61183 -2.86861C4.35859 -5.8085 7.16704 -7 11 -7C11 -7 11 -7 11 -7C7.34506 -7 1 -7 1 -7L1 19Z' fill='%23202c33'/%3E%3C/svg%3E"); }


        .message-time { color: var(--text-secondary); opacity: 0.7; }
        .system-message { background-color: var(--system-bg); color: var(--system-text); }
        mark { background-color: var(--highlight-bg); color: #000; padding: 1px 3px; border-radius: 3px; }
        .message-bubble a { color: var(--link-color); text-decoration: underline; }

        .date-separator {
            background-color: var(--system-bg);
            color: var(--system-text);
            font-size: 0.75em;
            font-weight: 500;
            text-align: center;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 15px auto 10px auto;
            max-width: fit-content;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            opacity: 0.9;
        }
        .media-placeholder {
            background-color: rgba(0,0,0,0.05);
            border: 1px dashed var(--text-secondary);
            border-radius: 5px;
            padding: 15px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-style: italic;
            color: var(--text-secondary);
        }
        .media-placeholder i { font-size: 1.5em; color: var(--icon-color); }
        .dark-theme .media-placeholder { background-color: rgba(255,255,255,0.05); }

        #controls { padding: 10px; background-color: var(--container-bg); border-bottom: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; transition: background-color 0.3s, border-color 0.3s;}
        #controls input, #controls select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--page-bg); color: var(--text-primary); }
        #controls button, #theme-toggle { background-color: var(--button-bg); color: var(--button-text); padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        #controls button:hover, #theme-toggle:hover { opacity: 0.9; }
        #theme-toggle { width: 40px; text-align: center; }

        .scroll-buttons { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 1000; }
        .scroll-buttons button { background-color: var(--button-bg); color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2em; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color 0.2s; display: flex; justify-content: center; align-items: center;}
        .scroll-buttons button:hover { opacity: 0.85; }
        
        .copy-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            color: var(--icon-color);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.8em;
            background-color: var(--chat-bg);
            padding: 3px 5px;
            border-radius: 3px;
        }
        .message-bubble:hover .copy-icon { opacity: 0.7; }
        .copy-icon:hover { opacity: 1; }

        #loading-indicator {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: var(--text-secondary);
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class=""> <div class="container bg-white shadow-xl rounded-lg w-full max-w-3xl flex flex-col my-5">
        <header class="p-4 text-center rounded-t-lg">
            <h1 class="text-2xl font-semibold">WhatsApp Chat Reader Pro</h1>
        </header>

        <div class="upload-section p-6 border-b">
            <label for="chatFile" class="block text-sm font-medium mb-2">
                Upload your exported WhatsApp chat file (.txt):
            </label>
            <input type="file" id="chatFile" accept=".txt" class="block w-full max-w-sm text-sm
                file:mr-4 file:py-2 file:px-4
                file:rounded-md file:border-0
                file:text-sm file:font-semibold
                file:bg-teal-50 file:text-teal-700
                hover:file:bg-teal-100
                cursor-pointer
            "/>
            <div id="errorMessage" class="error-message hidden mt-2"></div>
        </div>
        
        <div id="controls">
             <input type="search" id="searchInput" placeholder="Search chat...">
             <select id="userSelector">
                 <option value="">Select 'Me'</option>
             </select>
             <button id="theme-toggle"><i class="fas fa-moon"></i></button>
        </div>

        <div id="loading-indicator"><i class="fas fa-spinner fa-spin"></i> Parsing Chat...</div>
        <div id="chat-display-area">
            <p class="text-gray-500 text-center p-10">Upload a chat file to get started!</p>
        </div>
    </div>

    <div class="scroll-buttons">
        <button id="scrollToTop"><i class="fas fa-arrow-up"></i></button>
        <button id="scrollToBottom"><i class="fas fa-arrow-down"></i></button>
    </div>

    <script>
        // DOM Elements
        const chatFileInput = document.getElementById('chatFile');
        const chatDisplayArea = document.getElementById('chat-display-area');
        const errorMessageDiv = document.getElementById('errorMessage');
        const searchInput = document.getElementById('searchInput');
        const userSelector = document.getElementById('userSelector');
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const scrollToTopBtn = document.getElementById('scrollToTop');
        const scrollToBottomBtn = document.getElementById('scrollToBottom');
        const loadingIndicator = document.getElementById('loading-indicator');

        let allMessages = [];
        let uniqueSenders = new Set();
        let selectedUser = null;
        let senderColors = {};
        const predefinedSenderColors = [ '#e53935', '#3949ab', '#00897b', '#fb8c00', '#8e24aa', '#43a047', '#546e7a', '#d81b60' ];
        const mediaRegex = /<((image|video|audio|sticker|GIF) omitted|Contact card omitted|document omitted)>/i;
        const urlRegex = /(?:https?|ftp):\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*)/g;

        // --- Event Listeners ---
        chatFileInput.addEventListener('change', handleFileUpload);
        searchInput.addEventListener('input', handleSearch);
        userSelector.addEventListener('change', handleUserSelection);
        themeToggle.addEventListener('click', toggleTheme);
        scrollToTopBtn.addEventListener('click', () => chatDisplayArea.scrollTop = 0);
        scrollToBottomBtn.addEventListener('click', () => chatDisplayArea.scrollTop = chatDisplayArea.scrollHeight);
        chatDisplayArea.addEventListener('click', handleChatAreaClick);

        // --- Initial Setup ---
        loadTheme();

        // --- Functions ---

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                loadingIndicator.style.display = 'block';
                chatDisplayArea.innerHTML = '';
                errorMessageDiv.classList.add('hidden');

                const reader = new FileReader();
                reader.onload = (e) => {
                    setTimeout(() => { // Simulate processing time & allow UI update
                         parseChat(e.target.result);
                         loadingIndicator.style.display = 'none';
                    }, 50);
                };
                reader.onerror = () => {
                    showError("Error reading file.");
                    loadingIndicator.style.display = 'none';
                }
                reader.readAsText(file);
            }
        }

        function parseChat(chatText) {
            uniqueSenders = new Set();
            senderColors = {};
            allMessages = [];
            let currentMessageBuffer = null;
            const lines = chatText.split(/\r?\n/);
            const messageRegex = /^(\[?(\d{1,2}\/\d{1,2}\/\d{2,4}),? (\d{1,2}:\d{2}(?::\d{2})?(?: [AP]M)?)\]? ?-? ?)(?:([^:]+): )?(.*)$/s;

            lines.forEach(line => {
                const match = line.match(messageRegex);
                if (match) {
                    if (currentMessageBuffer) allMessages.push(currentMessageBuffer);
                    const sender = match[4] ? match[4].trim() : "System";
                    currentMessageBuffer = {
                        date: match[2], time: match[3], sender: sender,
                        text: match[5] ? match[5].trim() : "", isMedia: mediaRegex.test(match[5]),
                    };
                    if (sender !== "System") uniqueSenders.add(sender);
                } else if (currentMessageBuffer) {
                    currentMessageBuffer.text += '\n' + line.trim();
                    currentMessageBuffer.isMedia = currentMessageBuffer.isMedia || mediaRegex.test(line);
                } else if (line.trim() !== "") {
                    allMessages.push({ date: "", time: "", sender: "System", text: line.trim(), isMedia: false });
                }
            });
            if (currentMessageBuffer) allMessages.push(currentMessageBuffer);

            populateUserSelector();
            assignSenderColors();
            displayChat();
        }

        function populateUserSelector() {
            userSelector.innerHTML = '<option value="">Select \'Me\'</option>';
            Array.from(uniqueSenders).forEach(sender => {
                const option = document.createElement('option');
                option.value = sender;
                option.textContent = sender;
                userSelector.appendChild(option);
            });
            selectedUser = userSelector.options[1] ? userSelector.options[1].value : null; // Default to first sender
            userSelector.value = selectedUser || "";
        }

        function assignSenderColors() {
             Array.from(uniqueSenders).forEach((s, index) => {
                senderColors[s] = predefinedSenderColors[index % predefinedSenderColors.length];
            });
        }

        function displayChat() {
            chatDisplayArea.innerHTML = '';
            let lastDate = null;
            const searchTerm = searchInput.value.toLowerCase();

            allMessages.forEach(msg => {
                // Add Date Separator
                if (msg.date && msg.date !== lastDate) {
                    chatDisplayArea.appendChild(createDateSeparator(msg.date));
                    lastDate = msg.date;
                }
                // Create and add message bubble
                chatDisplayArea.appendChild(createMessageElement(msg, searchTerm));
            });
            chatDisplayArea.scrollTop = chatDisplayArea.scrollHeight;
        }

        function createDateSeparator(date) {
            const separator = document.createElement('div');
            separator.className = 'date-separator';
            // Optional: Format date more nicely here
            separator.textContent = date;
            return separator;
        }

        function createMessageElement(msg, searchTerm) {
            const isUser = msg.sender === selectedUser;
            const isSystem = msg.sender === "System" || isSystemLikeMessage(msg.text);
            
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-wrapper');

            if (isSystem) {
                wrapper.className = 'system-message';
                wrapper.innerHTML = highlightText(msg.text, searchTerm);
                return wrapper;
            }

            wrapper.classList.add(isUser ? 'user-message-wrapper' : 'other-message-wrapper');
            wrapper.setAttribute('data-sender', msg.sender); // Set data-sender attribute

            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');

            // Sender Name (if not user and not system)
            if (!isUser) {
                const header = document.createElement('div');
                header.className = 'message-header';
                const sender = document.createElement('div');
                sender.className = 'sender-name';
                sender.textContent = msg.sender;
                sender.style.color = senderColors[msg.sender] || '#8696a0';
                header.appendChild(sender);
                bubble.appendChild(header);
            }

            // Body (Text/Media and Time)
            const body = document.createElement('div');
            body.className = 'message-body';
            
            if (msg.isMedia) {
                body.appendChild(createMediaPlaceholder(msg.text));
            } else {
                const text = document.createElement('p');
                text.className = 'message-text';
                text.innerHTML = highlightText(linkifyText(msg.text), searchTerm); // Linkify first, then highlight
                body.appendChild(text);
            }

            const time = document.createElement('span');
            time.className = 'message-time';
            time.textContent = msg.time.replace(/ [AP]M$/, '').trim(); // Shorten time
            body.appendChild(time);

            // Copy Icon
            const copy = document.createElement('i');
            copy.className = 'fas fa-copy copy-icon';
            copy.title = 'Copy text';
            bubble.appendChild(copy);

            bubble.appendChild(body);
            wrapper.appendChild(bubble);

            // Hide if search term exists and doesn't match
            if (searchTerm && !msg.text.toLowerCase().includes(searchTerm)) {
                 wrapper.style.display = 'none';
            }

            return wrapper;
        }
        
        function createMediaPlaceholder(text) {
            const placeholder = document.createElement('div');
            placeholder.className = 'media-placeholder';
            let iconClass = 'fa-file'; // Default
            if (text.includes('image')) iconClass = 'fa-image';
            else if (text.includes('video')) iconClass = 'fa-video';
            else if (text.includes('audio')) iconClass = 'fa-headphones';
            else if (text.includes('sticker')) iconClass = 'fa-sticky-note';
            else if (text.includes('Contact')) iconClass = 'fa-address-card';
            
            placeholder.innerHTML = `<i class="fas ${iconClass}"></i> ${text}`;
            return placeholder;
        }

        function linkifyText(text) {
             return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
        }

        function highlightText(text, term) {
            if (!term) return text;
            const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, `<mark>$1</mark>`);
        }
        
        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            const messages = chatDisplayArea.querySelectorAll('.message-wrapper');
            let firstMatch = null;
            
            messages.forEach(msg => {
                const textElement = msg.querySelector('.message-text') || msg; // Use wrapper for system messages
                const senderElement = msg.querySelector('.sender-name');
                const text = textElement.textContent.toLowerCase();
                const sender = senderElement ? senderElement.textContent.toLowerCase() : '';
                
                // Remove existing marks
                textElement.innerHTML = textElement.innerHTML.replace(/<mark>|<\/mark>/gi, '');

                if (searchTerm && (text.includes(searchTerm) || sender.includes(searchTerm))) {
                    msg.style.display = 'flex'; // Ensure it's visible
                    textElement.innerHTML = highlightText(textElement.innerHTML, searchTerm);
                    if (!firstMatch) firstMatch = msg;
                } else if (searchTerm) {
                    msg.style.display = 'none'; // Hide non-matches
                } else {
                    msg.style.display = 'flex'; // Show all if search is cleared
                }
            });
            // if (firstMatch) firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function handleUserSelection(event) {
            selectedUser = event.target.value;
            // Re-render chat with new user selection
            displayChat();
        }

        function toggleTheme() {
            body.classList.toggle('dark-theme');
            const isDark = body.classList.contains('dark-theme');
            themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Force redraw tails by re-parsing (or update SVGs with JS)
            displayChat(); 
        }

        function loadTheme() {
            if (localStorage.getItem('theme') === 'dark') {
                body.classList.add('dark-theme');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                 themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        function handleChatAreaClick(event) {
            if (event.target.classList.contains('copy-icon')) {
                const bubble = event.target.closest('.message-bubble');
                const textElement = bubble.querySelector('.message-text');
                if (textElement) {
                    navigator.clipboard.writeText(textElement.textContent)
                        .then(() => { 
                            event.target.classList.remove('fa-copy');
                            event.target.classList.add('fa-check');
                            setTimeout(() => {
                                 event.target.classList.remove('fa-check');
                                 event.target.classList.add('fa-copy');
                            }, 1500);
                         })
                        .catch(err => console.error('Failed to copy text: ', err));
                }
            }
        }

        function isSystemLikeMessage(text) { /* ... (same as before) ... */ return false; } // Simplified for now
        function showError(message) { /* ... (same as before) ... */ }

    </script>
</body>
</html>
